library(ArchR)
set.seed(1)
addArchRThreads(threads = 32)

setwd("archr-1.0.1-dedoublet") # set this to your working dir

reformatFragmentFiles(fragmentFiles="bwa_filtered.tsv")
reformatFragmentFiles(fragmentFiles="bwa_sub1_filtered.tsv")
reformatFragmentFiles(fragmentFiles="bwa_sub2_filtered.tsv")
reformatFragmentFiles(fragmentFiles="bowtie2_filtered.tsv")
reformatFragmentFiles(fragmentFiles="chromap_filtered.tsv")

reformatFragmentFiles(fragmentFiles="bwa_cell_filtered.tsv")
reformatFragmentFiles(fragmentFiles="chromap_cell_filtered.tsv")

addArchRGenome("hg38")

bwa_ArrowFiles<-createArrowFiles(inputFiles="bwa_filtered.tsv.gz", sampleNames = "PBMC10K_bwa", filterFrags = 1000, filterTSS = 10, offsetPlus = 0, offsetMinus = 0)
bwa_sub1_ArrowFiles<-createArrowFiles(inputFiles="bwa_sub1_filtered.tsv.gz", sampleNames = "PBMC10K_bwa_sub1", filterFrags = 1000, filterTSS = 10, offsetPlus = 0, offsetMinus = 0)
bwa_sub2_ArrowFiles<-createArrowFiles(inputFiles="bwa_sub2_filtered.tsv.gz", sampleNames = "PBMC10K_bwa_sub2", filterFrags = 1000, filterTSS = 10, offsetPlus = 0, offsetMinus = 0)
bowtie2_ArrowFiles<-createArrowFiles(inputFiles="bowtie2_filtered.tsv.gz", sampleNames = "PBMC10K_bowtie2", filterFrags = 1000, filterTSS = 10, offsetPlus = 0, offsetMinus = 0)
chromap_ArrowFiles<-createArrowFiles(inputFiles="chromap_filtered.tsv.gz", sampleNames = "PBMC10K_chromap", filterFrags = 1000, filterTSS = 10, offsetPlus = 0, offsetMinus = 0)
bwa_cell_ArrowFiles<-createArrowFiles(inputFiles="bwa_cell_filtered.tsv.gz", sampleNames = "PBMC10K_bwa_cell", filterFrags = 1000, filterTSS = 10, offsetPlus = 0, offsetMinus = 0)
chromap_cell_ArrowFiles<-createArrowFiles(inputFiles="chromap_cell_filtered.tsv.gz", sampleNames = "PBMC10K_chromap_cell", filterFrags = 1000, filterTSS = 10, offsetPlus = 0, offsetMinus = 0)

bwa_doubScores <- addDoubletScores(input = bwa_ArrowFiles, k = 10, knnMethod = "UMAP", LSIMethod = 1)
bwa_sub1_doubScores <- addDoubletScores(input = bwa_sub1_ArrowFiles, k = 10, knnMethod = "UMAP", LSIMethod = 1)
bwa_sub2_doubScores <- addDoubletScores(input = bwa_sub2_ArrowFiles, k = 10, knnMethod = "UMAP", LSIMethod = 1)
bowtie2_doubScores <- addDoubletScores(input = bowtie2_ArrowFiles, k = 10, knnMethod = "UMAP", LSIMethod = 1)
chromap_doubScores <- addDoubletScores(input = chromap_ArrowFiles, k = 10, knnMethod = "UMAP", LSIMethod = 1)
bwa_cell_doubScores <- addDoubletScores(input = bwa_cell_ArrowFiles, k = 10, knnMethod = "UMAP", LSIMethod = 1)
chromap_cell_doubScores <- addDoubletScores(input = chromap_cell_ArrowFiles, k = 10, knnMethod = "UMAP", LSIMethod = 1)

bwa_proj <- ArchRProject(ArrowFiles = bwa_ArrowFiles, outputDirectory = "PBMC10K")
bwa_sub1_proj <- ArchRProject(ArrowFiles = bwa_sub1_ArrowFiles, outputDirectory = "PBMC10K")
bwa_sub2_proj <- ArchRProject(ArrowFiles = bwa_sub2_ArrowFiles, outputDirectory = "PBMC10K")
bowtie2_proj <- ArchRProject(ArrowFiles = bowtie2_ArrowFiles, outputDirectory = "PBMC10K")
chromap_proj <- ArchRProject(ArrowFiles = chromap_ArrowFiles, outputDirectory = "PBMC10K")
bwa_cell_proj <- ArchRProject(ArrowFiles = bwa_cell_ArrowFiles, outputDirectory = "PBMC10K")
chromap_cell_proj <- ArchRProject(ArrowFiles = chromap_cell_ArrowFiles, outputDirectory = "PBMC10K")

bwa_proj <- filterDoublets(ArchRProj = bwa_proj)
bwa_sub1_proj <- filterDoublets(ArchRProj = bwa_sub1_proj)
bwa_sub2_proj <- filterDoublets(ArchRProj = bwa_sub2_proj)
bowtie2_proj <- filterDoublets(ArchRProj = bowtie2_proj)
chromap_proj <- filterDoublets(ArchRProj = chromap_proj)
bwa_cell_proj <- filterDoublets(ArchRProj = bwa_cell_proj)
chromap_cell_proj <- filterDoublets(ArchRProj = chromap_cell_proj)

bwa_proj <- addIterativeLSI(ArchRProj = bwa_proj, useMatrix = "TileMatrix", name = "IterativeLSI", clusterParams = list(resolution = c(0.6), sampleCells = NULL, maxClusters = NULL, n.start = 10))
bwa_sub1_proj <- addIterativeLSI(ArchRProj = bwa_sub1_proj, useMatrix = "TileMatrix", name = "IterativeLSI")
bwa_sub2_proj <- addIterativeLSI(ArchRProj = bwa_sub2_proj, useMatrix = "TileMatrix", name = "IterativeLSI")
bowtie2_proj <- addIterativeLSI(ArchRProj = bowtie2_proj, useMatrix = "TileMatrix", name = "IterativeLSI", clusterParams = list(resolution = c(0.6), sampleCells = NULL, maxClusters = NULL, n.start = 10))
chromap_proj <- addIterativeLSI(ArchRProj = chromap_proj, useMatrix = "TileMatrix", name = "IterativeLSI", clusterParams = list(resolution = c(0.6), sampleCells = NULL, maxClusters = NULL, n.start = 10))
bwa_cell_proj <- addIterativeLSI(ArchRProj = bwa_cell_proj, useMatrix = "TileMatrix", name = "IterativeLSI", clusterParams = list(resolution = c(0.6), sampleCells = NULL, maxClusters = NULL, n.start = 10))
chromap_cell_proj <- addIterativeLSI(ArchRProj = chromap_cell_proj, useMatrix = "TileMatrix", name = "IterativeLSI", clusterParams = list(resolution = c(0.6), sampleCells = NULL, maxClusters = NULL, n.start = 10))

bwa_proj <- addClusters(input = bwa_proj, reducedDims = "IterativeLSI", resolution = 0.6, maxClusters = NULL)
bwa_sub1_proj <- addClusters(input = bwa_sub1_proj, reducedDims = "IterativeLSI")
bwa_sub2_proj <- addClusters(input = bwa_sub2_proj, reducedDims = "IterativeLSI")
bowtie2_proj <- addClusters(input = bowtie2_proj, reducedDims = "IterativeLSI", resolution = 0.6, maxClusters = NULL)
chromap_proj <- addClusters(input = chromap_proj, reducedDims = "IterativeLSI", resolution = 0.6, maxClusters = NULL)
bwa_cell_proj <- addClusters(input = bwa_cell_proj, reducedDims = "IterativeLSI", resolution = 0.6, maxClusters = NULL)
chromap_cell_proj <- addClusters(input = chromap_cell_proj, reducedDims = "IterativeLSI", resolution = 0.6, maxClusters = NULL)

bwa_proj <- addUMAP(ArchRProj = bwa_proj, reducedDims = "IterativeLSI")
bwa_sub1_proj <- addUMAP(ArchRProj = bwa_sub1_proj, reducedDims = "IterativeLSI")
bwa_sub2_proj <- addUMAP(ArchRProj = bwa_sub2_proj, reducedDims = "IterativeLSI")
bowtie2_proj <- addUMAP(ArchRProj = bowtie2_proj, reducedDims = "IterativeLSI")
chromap_proj <- addUMAP(ArchRProj = chromap_proj, reducedDims = "IterativeLSI")
bwa_cell_proj <- addUMAP(ArchRProj = bwa_cell_proj, reducedDims = "IterativeLSI")
chromap_cell_proj <- addUMAP(ArchRProj = chromap_cell_proj, reducedDims = "IterativeLSI")

bwa_proj <- saveArchRProject(ArchRProj = bwa_proj, outputDirectory = "bwa")
bwa_sub1_proj <- saveArchRProject(ArchRProj = bwa_sub1_proj, outputDirectory = "bwa_sub1")
bwa_sub2_proj <- saveArchRProject(ArchRProj = bwa_sub2_proj, outputDirectory = "bwa_sub2")
bowtie2_proj <- saveArchRProject(ArchRProj = bowtie2_proj, outputDirectory = "bowtie2")
chromap_proj <- saveArchRProject(ArchRProj = chromap_proj, outputDirectory = "chromap")
bwa_cell_proj <- saveArchRProject(ArchRProj = bwa_cell_proj, outputDirectory = "bwa_cell")
chromap_cell_proj <- saveArchRProject(ArchRProj = chromap_cell_proj, outputDirectory = "chromap_cell")

bwa_p <- plotEmbedding(ArchRProj = bwa_proj, colorBy = "cellColData", name = "Clusters", embedding = "UMAP")
bwa_sub1_p <- plotEmbedding(ArchRProj = bwa_sub1_proj, colorBy = "cellColData", name = "Clusters", embedding = "UMAP")
bwa_sub2_p <- plotEmbedding(ArchRProj = bwa_sub2_proj, colorBy = "cellColData", name = "Clusters", embedding = "UMAP")
bowtie2_p <- plotEmbedding(ArchRProj = bowtie2_proj, colorBy = "cellColData", name = "Clusters", embedding = "UMAP")
chromap_p <- plotEmbedding(ArchRProj = chromap_proj, colorBy = "cellColData", name = "Clusters", embedding = "UMAP")
bwa_cell_p <- plotEmbedding(ArchRProj = bwa_cell_proj, colorBy = "cellColData", name = "Clusters", embedding = "UMAP")
chromap_cell_p <- plotEmbedding(ArchRProj = chromap_cell_proj, colorBy = "cellColData", name = "Clusters", embedding = "UMAP")

plotPDF(bwa_p, name = "PBMC10K-bwa-Plot-UMAP-Clusters.pdf", ArchRProj = bwa_proj, addDOC = FALSE, width = 5, height = 5)
plotPDF(bwa_sub1_p, name = "PBMC10K-bwa-sub1-Plot-UMAP-Clusters.pdf", ArchRProj = bwa_sub1_proj, addDOC = FALSE, width = 5, height = 5)
plotPDF(bwa_sub2_p, name = "PBMC10K-bwa-sub2-Plot-UMAP-Clusters.pdf", ArchRProj = bwa_sub2_proj, addDOC = FALSE, width = 5, height = 5)
plotPDF(bowtie2_p, name = "PBMC10K-bowtie2-Plot-UMAP-Clusters.pdf", ArchRProj = bowtie2_proj, addDOC = FALSE, width = 5, height = 5)
plotPDF(chromap_p, name = "PBMC10K-chromap-Plot-UMAP-Clusters.pdf", ArchRProj = chromap_proj, addDOC = FALSE, width = 5, height = 5)
plotPDF(bwa_cell_p, name = "PBMC10K-bwa-cell-Plot-UMAP-Clusters.pdf", ArchRProj = bwa_cell_proj, addDOC = FALSE, width = 5, height = 5)
plotPDF(chromap_cell_p, name = "PBMC10K-chromap-cell-Plot-UMAP-Clusters.pdf", ArchRProj = chromap_cell_proj, addDOC = FALSE, width = 5, height = 5)
